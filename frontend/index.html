<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background-color: #f4f7f9; color: #333; }
    .container { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    button { margin: 10px; padding: 12px 24px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; font-size: 16px; transition: 0.2s; }
    button:hover { background-color: #e9ecef; }
    
    /* ã‚¯ã‚¤ã‚ºé¸æŠè‚¢ãƒœã‚¿ãƒ³ */
    .choice-btn { display: block; width: 80%; margin: 10px auto; background: white; border: 2px solid #007bff; color: #007bff; font-weight: bold; }
    .choice-btn:hover { background: #007bff; color: white; }
    
    /* è§£èª¬ã‚¨ãƒªã‚¢ */
    #explanation-area { margin-top: 20px; padding: 20px; border-radius: 8px; text-align: left; display: none; }
    .correct-box { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .incorrect-box { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    
    table { margin: 20px auto; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background-color: #eee; }
    input { padding: 10px; width: 60%; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
    .next-btn { background-color: #28a745; color: white; border: none; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h1>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>

  <div id="name-area">
    <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    <button onclick="startGame()" style="background: #007bff; color: white; border: none;">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
  </div>

  <div id="quiz-area" style="display:none;">
    <h2 id="question"></h2>
    <p>â³ æ®‹ã‚Šæ™‚é–“ï¼š<span id="time" style="font-weight:bold; color:red;">10</span> ç§’</p>
    <div id="choices"></div>
    
    <div id="explanation-area">
      <h3 id="result-text"></h3>
      <p id="correct-answer-info"></p>
      <div id="explanation-content" style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px;"></div>
      <button id="next-button" class="next-btn" onclick="loadQuiz()">æ¬¡ã®å•é¡Œã¸ ğŸ‘‰</button>
    </div>

    <hr style="margin-top: 30px;">
    <p>ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼š<span id="score" style="font-size: 1.2em; font-weight: bold;">0</span></p>
  </div>

  <div id="result-area" style="display:none;"></div>
</div>

<script>
let currentQuiz = null;
let score = 0;
let playerName = "";
let timeLeft = 10;
let timer = null;
let usedQuizIds = [];
let totalCount = 0;

// ã‚²ãƒ¼ãƒ é–‹å§‹
async function startGame() {
  playerName = document.getElementById("playerName").value;
  if (!playerName) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  const res = await fetch("/api/quiz/count");
  const data = await res.json();
  totalCount = data.count;

  score = 0;
  usedQuizIds = [];
  document.getElementById("score").innerText = score;
  document.getElementById("name-area").style.display = "none";
  document.getElementById("quiz-area").style.display = "block";

  loadQuiz();
}

// ã‚¯ã‚¤ã‚ºå–å¾—
async function loadQuiz() {
  clearInterval(timer);
  // è¡¨ç¤ºã®åˆæœŸåŒ–
  document.getElementById("explanation-area").style.display = "none";
  document.getElementById("choices").style.display = "block";

  if (usedQuizIds.length >= totalCount && totalCount > 0) {
    endGame();
    return;
  }

  let data;
  while (true) {
    const res = await fetch("/api/quiz/random");
    data = await res.json();
    if (!usedQuizIds.includes(data.id)) break;
  }

  currentQuiz = data;
  usedQuizIds.push(data.id);
  document.getElementById("question").innerText = data.question;

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒœã‚¿ãƒ³ä½œæˆ
  const choicesArray = Object.entries(data.choices);
  for (let i = choicesArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [choicesArray[i], choicesArray[j]] = [choicesArray[j], choicesArray[i]];
  }

  const choicesDiv = document.getElementById("choices");
  choicesDiv.innerHTML = "";
  choicesArray.forEach(([key, value]) => {
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.innerText = value;
    btn.onclick = () => submitAnswer(key);
    choicesDiv.appendChild(btn);
  });

  startTimer();
}

// ã‚¿ã‚¤ãƒãƒ¼
function startTimer() {
  timeLeft = 10;
  document.getElementById("time").innerText = timeLeft;
  timer = setInterval(() => {
    timeLeft--;
    document.getElementById("time").innerText = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timer);
      showExplanation(false, "â° æ™‚é–“åˆ‡ã‚Œï¼");
    }
  }, 1000);
}

// å›ç­”é€ä¿¡
async function submitAnswer(choice) {
  clearInterval(timer);
  const res = await fetch(`/api/quiz/answer/${currentQuiz.id}?answer=${choice}`, { method: "POST" });
  const result = await res.json();

  if (result.correct) {
    score += 10;
    document.getElementById("score").innerText = score;
    showExplanation(true, "â­• æ­£è§£ï¼", result);
  } else {
    showExplanation(false, "âŒ ä¸æ­£è§£...", result);
  }
}

// è§£èª¬ã®è¡¨ç¤º
function showExplanation(isCorrect, title, resultData = null) {
  const area = document.getElementById("explanation-area");
  const resText = document.getElementById("result-text");
  const choicesDiv = document.getElementById("choices");
  
  choicesDiv.style.display = "none"; // é¸æŠè‚¢ã‚’éš ã™
  area.style.display = "block";      // è§£èª¬ã‚’å‡ºã™
  area.className = isCorrect ? "correct-box" : "incorrect-box";
  
  resText.innerText = title;
  
  if (resultData) {
    document.getElementById("correct-answer-info").innerHTML = `æ­£è§£ã¯ <strong>${resultData.correct_answer}</strong> ã§ã—ãŸã€‚`;
    document.getElementById("explanation-content").innerHTML = `<strong>ğŸ’¡ è§£èª¬:</strong><br>${resultData.explanation || 'è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}`;
  } else {
    // æ™‚é–“åˆ‡ã‚Œã®å ´åˆãªã©
    document.getElementById("correct-answer-info").innerText = "";
    document.getElementById("explanation-content").innerText = "æ™‚é–“ã‚’éãã¦ã—ã¾ã„ã¾ã—ãŸã€‚";
  }
}

// çµ‚äº†å‡¦ç†
async function endGame() {
  document.getElementById("quiz-area").style.display = "none";
  document.getElementById("result-area").style.display = "block";

  await fetch(`/api/score?player_name=${encodeURIComponent(playerName)}&score=${score}`, { method: "POST" });
  const res = await fetch("/api/score/ranking");
  const ranking = await res.json();

  let html = `
    <h2>ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸ‰</h2>
    <p>${playerName} ã•ã‚“ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼š<strong>${score} ç‚¹</strong></p>
    <h3>ğŸ† TOP 10 ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <table>
      <tr><th>é †ä½</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th></tr>
  `;
  ranking.forEach((r, i) => {
    html += `<tr><td>${i+1}</td><td>${r.player_name}</td><td>${r.score}</td></tr>`;
  });
  html += `</table><br><button onclick="resetGame()">ğŸ” ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>`;
  document.getElementById("result-area").innerHTML = html;
}

function resetGame() {
  location.reload(); // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
}
</script>
</body>
</html>