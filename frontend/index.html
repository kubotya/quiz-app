<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    button { margin: 5px; padding: 10px 20px; }
    table {
      margin: auto;
      border-collapse: collapse;
      width: 60%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
  </style>
</head>
<body>

<h1>ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>

<!-- åå‰å…¥åŠ› -->
<div id="name-area">
  <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›">
  <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<!-- ã‚¯ã‚¤ã‚º -->
<div id="quiz-area" style="display:none;">
  <h2 id="question"></h2>
  <p>æ®‹ã‚Šæ™‚é–“ï¼š<span id="time">10</span> ç§’</p>
  <div id="choices"></div>
  <p id="result"></p>
  <p>ã‚¹ã‚³ã‚¢ï¼š<span id="score">0</span></p>
</div>

<!-- çµæœ -->
<div id="result-area" style="display:none;"></div>

<script>
let currentQuiz = null;
let score = 0;
let playerName = "";
let timeLeft = 10;
let timer = null;

let usedQuizIds = [];
let totalCount = 0;

// ========================
// ã‚²ãƒ¼ãƒ é–‹å§‹
// ========================
async function startGame() {
  playerName = document.getElementById("playerName").value;
  if (!playerName) {
    alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await fetch("/api/quiz/count");
  const data = await res.json();
  totalCount = data.count;

  score = 0;
  usedQuizIds = [];
  document.getElementById("score").innerText = score;

  document.getElementById("name-area").style.display = "none";
  document.getElementById("result-area").style.display = "none";
  document.getElementById("quiz-area").style.display = "block";

  loadQuiz();
}

// ========================
// ã‚¯ã‚¤ã‚ºå–å¾—ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
// ========================
async function loadQuiz() {
  clearInterval(timer);
  document.getElementById("result").innerText = "";

  if (usedQuizIds.length >= totalCount) {
    endGame();
    return;
  }

  let data;
  while (true) {
    const res = await fetch("/api/quiz/random");
    data = await res.json();
    if (!usedQuizIds.includes(data.id)) break;
  }

  currentQuiz = data;
  usedQuizIds.push(data.id);

  document.getElementById("question").innerText = data.question;

  // ========= ãƒ©ãƒ³ãƒ€ãƒ é…ç½® =========
  const choicesArray = Object.entries(data.choices);
  shuffleArray(choicesArray);

  const choicesDiv = document.getElementById("choices");
  choicesDiv.innerHTML = "";

  choicesArray.forEach(([key, value]) => {
    const btn = document.createElement("button");
    btn.innerText = value;
    btn.onclick = () => submitAnswer(key);
    choicesDiv.appendChild(btn);
  });

  startTimer();
}

// ========================
// é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yatesï¼‰
// ========================
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// ========================
// ã‚¿ã‚¤ãƒãƒ¼
// ========================
function startTimer() {
  timeLeft = 10;
  document.getElementById("time").innerText = timeLeft;

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById("time").innerText = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timer);
      document.getElementById("result").innerText = "â° æ™‚é–“åˆ‡ã‚Œ";
      setTimeout(loadQuiz, 1000);
    }
  }, 1000);
}

// ========================
// å›ç­”é€ä¿¡
// ========================
async function submitAnswer(choice) {
  clearInterval(timer);

  const res = await fetch(
    `/api/quiz/answer/${currentQuiz.id}?answer=${choice}`,
    { method: "POST" }
  );
  const result = await res.json();

  if (result.correct) {
    document.getElementById("result").innerText = "â­• æ­£è§£ï¼";
    score += 10;
  } else {
    document.getElementById("result").innerText = "âŒ ä¸æ­£è§£";
  }

  document.getElementById("score").innerText = score;
  setTimeout(loadQuiz, 1000);
}

// ========================
// çµ‚äº† & ãƒ©ãƒ³ã‚­ãƒ³ã‚°
// ========================
async function endGame() {
  clearInterval(timer);

  document.getElementById("quiz-area").style.display = "none";
  document.getElementById("result-area").style.display = "block";

  await fetch(`/api/score?player_name=${playerName}&score=${score}`, {
    method: "POST"
  });

  const res = await fetch("/api/score/ranking");
  const ranking = await res.json();

  let html = `
    <h2>ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº† ğŸ‰</h2>
    <p>${playerName} ã•ã‚“ã®ã‚¹ã‚³ã‚¢ï¼š<strong>${score} ç‚¹</strong></p>
    <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <table>
      <tr><th>é †ä½</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th></tr>
  `;

  ranking.forEach((r, i) => {
    html += `<tr><td>${i+1}</td><td>${r.player_name}</td><td>${r.score}</td></tr>`;
  });

  html += `
    </table>
    <br>
    <button onclick="resetGame()">ğŸ” ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
  `;

  document.getElementById("result-area").innerHTML = html;
}

// ========================
// ãƒªã‚»ãƒƒãƒˆ
// ========================
function resetGame() {
  score = 0;
  usedQuizIds = [];
  currentQuiz = null;
  playerName = "";

  document.getElementById("playerName").value = "";
  document.getElementById("score").innerText = "0";

  document.getElementById("result-area").style.display = "none";
  document.getElementById("quiz-area").style.display = "none";
  document.getElementById("name-area").style.display = "block";
}
</script>

</body>
</html>
